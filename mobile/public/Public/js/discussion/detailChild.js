Vue.use(VueLazyload, {
    preLoad: 1.3,
    error: false,
    loading: '/Public/image/holder.png',
    attempt: 1,
})

var VmDiscussion = new Vue({
    el: '#discussionChild',
    data: function () {
        return {
            time: '',
            isFollow: false,
            info: {
                "title": "\u5c0f\u6811\u6797\u4e4b\u56db",
                "id": "1724",
                "artwork_id": "1650",
                "artname": "\u5c0f\u6811\u6797\u4e4b\u56db",
                "artwork_cover": "https:\/\/artzhe.oss-cn-shenzhen.aliyuncs.com\/user\/112\/144\/files\/2018\/11\/ejih02v42d.jpg",
                "orgImages": ["https:\/\/artzhe.oss-cn-shenzhen.aliyuncs.com\/user\/112\/144\/files\/2018\/11\/ejih02v42d.jpg?x-oss-process=image\/watermark,image_dXBsb2Fkcy8yMDE3LzA2LzE0LzE0OTc0MTExMDg2MjkzODIucG5nP3gtb3NzLXByb2Nlc3M9aW1hZ2UvcmVzaXplLFBfMTU,t_50,g_se,x_10,y_10\/quality,q_50"],
                "time": "2018-11-21",
                "artistid": 112144,
                "publisher": "\u674e\u4fca",
                "wit": "<img src=\"https:\/\/artzhe.oss-cn-shenzhen.aliyuncs.com\/user\/112\/144\/files\/2018\/11\/ejih02v42d.jpg?x-oss-process=image\/resize,m_fixed,w_702,q=50,image\/format,jpg\" id=\"1542776605497\"><div>\u5176\u4ed6\u7684\u6811\u90fd\u5728\u96fe\u91cc<\/div>",
                "cover": "https:\/\/artzhe.oss-cn-shenzhen.aliyuncs.com\/user\/112\/144\/files\/2018\/11\/ejih02v42d.jpg",
                "tags": ["\u4e19\u70ef", "\u98ce\u666f", "\u62bd\u8c61"],
                "commentList": [],
                "commentTotal": "0",
                "is_repay": "N",
                "is_edit": "N",
                "is_finished": "N",
                "is_like": "N",
                "likes": [],
                "number": "1",
                "like_total": "0",
                "view_total": "9",
                "create_time": "2018-11-21",
                "publisherInfo": {
                    "id": "112144",
                    "nickname": "\u674e\u4fca",
                    "name": "\u674e\u4fca",
                    "gender": "1",
                    "face": "https:\/\/artzhe.oss-cn-shenzhen.aliyuncs.com\/other\/artzhe\/user\/android2017-11-01-190835-iip7fedei9.jpg?x-oss-process=image\/resize,m_fill,h_180,w_180,limit_0,image\/format,jpg",
                    "motto": "",
                    "artTotal": "34",
                    "faceUrl": "https:\/\/artzhe.oss-cn-shenzhen.aliyuncs.com\/other\/artzhe\/user\/android2017-11-01-190835-iip7fedei9.jpg?x-oss-process=image\/resize,m_fill,h_180,w_180,limit_0,image\/format,jpg",
                    "isFollow": "N",
                    "follower_total": "275"
                },
                "shareTitle": "\u674e\u4fca \u5c0f\u6811\u6797\u4e4b\u56db",
                "shareDesc": "",
                "shareImg": "https:\/\/artzhe.oss-cn-shenzhen.aliyuncs.com\/user\/112\/144\/files\/2018\/11\/ejih02v42d.jpg?x-oss-process=image\/resize,m_fixed,h_180,w_180,P_10",
                "shareLink": "https:\/\/m.artzhe.com\/artwork\/update\/1724",
                "related": [{
                    "id": "1711",
                    "number": "1",
                    "summary": "\u7b2c\u4e09\u5f20\u4e86",
                    "create_date": "2018-11-13",
                    "cover": "https:\/\/artzhe.oss-cn-shenzhen.aliyuncs.com\/user\/112\/144\/files\/2018\/11\/pgg826itq0.jpg?x-oss-process=image\/resize,m_fill,h_300,w_300,limit_0,image\/format,jpg",
                    "title": "\u5c0f\u6811\u6797\u4e4b\u4e09"
                }, {
                    "id": "1708",
                    "number": "1",
                    "summary": "\u5c0f\u6811\u6797\u8ba1\u5212",
                    "create_date": "2018-11-11",
                    "cover": "https:\/\/artzhe.oss-cn-shenzhen.aliyuncs.com\/user\/112\/144\/files\/2018\/11\/vze2ibuz54.jpg?x-oss-process=image\/resize,m_fill,h_300,w_300,limit_0,image\/format,jpg",
                    "title": "\u5c0f\u6811\u6797\u4e4b\u4e8c"
                }, {
                    "id": "1691",
                    "number": "1",
                    "summary": "\u6253\u7b97\u753b\u4e00\u7cfb\u5217\u7684\u5c0f\u6811\u6797\uff0c\u6240\u4ee5\u4ece\u8fd9\u4e00\u526f\u5f00\u59cb\u5427\ud83d\ude0a",
                    "create_date": "2018-10-26",
                    "cover": "https:\/\/artzhe.oss-cn-shenzhen.aliyuncs.com\/user\/112\/144\/files\/2018\/10\/iqqq8yjf5u.jpg?x-oss-process=image\/resize,m_fill,h_300,w_300,limit_0,image\/format,jpg",
                    "title": "2018.10.26"
                }, {
                    "id": "1501",
                    "number": "1",
                    "summary": "\u753b\u4e86\u5f88\u4e45\u4e86\u3002\u5c31\u662f\u6ca1\u4e0a\u4f20\uff5e",
                    "create_date": "2018-06-07",
                    "cover": "https:\/\/artzhe.oss-cn-shenzhen.aliyuncs.com\/user\/112\/144\/files\/2018\/06\/c63r6sn3e3.jpg?x-oss-process=image\/resize,m_fill,h_300,w_300,limit_0,image\/format,jpg",
                    "title": "\u7ea2\u5899\u751f\u6d3b\u4e4b\u516d"
                }, {
                    "id": "1337",
                    "number": "1",
                    "summary": "\u6811\u548c\u623f\u5b50\u7684\u548c\u8c10",
                    "create_date": "2018-04-01",
                    "cover": "https:\/\/artzhe.oss-cn-shenzhen.aliyuncs.com\/user\/112\/144\/files\/2018\/04\/ss8p3k715x.jpg?x-oss-process=image\/resize,m_fill,h_300,w_300,limit_0,image\/format,jpg",
                    "title": "\u7ea2\u5899\u751f\u6d3b\u4e94"
                }],
                "shareInfo": {
                    "cover": "",
                    "face": "https:\/\/artzhe.oss-cn-shenzhen.aliyuncs.com\/other\/artzhe\/user\/android2017-11-01-190835-iip7fedei9.jpg",
                    "name": "\u674e\u4fca",
                    "motto": "",
                    "category": "\u63d2\u753b\/\u7d20\u63cf\/\u4e19\u70ef",
                    "link": "https:\/\/m.artzhe.com\/artwork\/update\/1724"
                }
            },
            update: '',
            selected: '1',
            loading: false,
            replaylist: [],
            likeslist: [],
            zanlist: [],
        }
    },
    created: function () {
        //test数据,过后删除
        this.update = this.info;
        this.update.time = this.formatTime(this.update.time)
        //
    },
    mounted: function () {
        if (FastClick) {
            FastClick.attach(document.body);
        }
        // this.init()
        for (let i = 1; i <= 20; i++) {
            this.replaylist.push(i);
        }
    },
    methods: {
        init: function (h5_token, updateId) {
            var that = this;
            this.updateId = this.GetLocationId() || '-1';

            var data = {
                h5_token: h5_token ? h5_token : this.GetRequest().h5_token,
                id: updateId ? updateId : this.updateId
            };

            var route = 'MobileGetH5/ArtworkUpdateDetail';
            var api = window.location.origin + '/V32/' + route;

            $.ajax({
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                type: "POST",
                url: api,
                data: data,
                success: function (res) {
                    if (res.code == 30000) {
                        document.title = res.data.info.artname;
                        var update = res.data.info;
                        // 去除为空的tag
                        // if(update.tags.length>0){
                        //   var u = update.tags.length;
                        //   while(u--){
                        //     if(arr[u]==''){
                        //       update.tags.splice(u,1);
                        //     }
                        //   }
                        // }
                        //

                        update.time = that.formatTime(update.time); //时间格式化

                        update.artname = that.checkMark(update.artname);
                        var artObj = {
                            type: 'artworkDetail',
                            id: update.artwork_id
                        };
                        that.artStr = JSON.stringify(artObj);
                        if (update.is_finished == "Y") {
                            update.number = 0;
                        } else if (update.number > 9) {
                            update.number = 10;
                        } else {
                            update.number = update.number; //可省略
                        }

                        if (update.commentList.length > 5) {
                            update.commentList = update.commentList.slice(0, 5);
                        }
                        if (update.likes.length > 10) {
                            update.likes = update.likes.slice(0, 10);
                        }

                        update.wit = px2rem(update.wit);

                        //图片懒加载

                        var el = document.createElement('div');
                        el.innerHTML = update.wit;
                        var $el = $(el);
                        var imgs = $el.find('img');
                        imgNum = $("img").length,

                            imgs.each(function () {
                                var src = $(this).attr("src");
                                $(this).attr("data-original", src);
                                $(this).attr('src', '/Public/image/holder.png');
                            });

                        update.wit = el.innerHTML;

                        that.update = update;
                        that.publisher = update.publisher;
                        that.$nextTick(function () {
                            $(".view img").lazyload({
                                threshold: 200,
                                event: "scrollstop", //滚动加载
                                effect: "fadeIn" //淡入
                            });
                            var $imgList = $('.view img');
                            $imgList.click(function (event) { //绑定图片点击事件
                                var index = $imgList.index(this);
                                that.gotoApp('image', index);
                            });

                            function pauseAll() {
                                $('.audioPlayBox').attr('data-flag', false);
                                for (var i = 0, len = $('audio').length; i < len; i++) {
                                    // $('audio')[i].currentTime=0;
                                    $('audio')[i].volume = 0.5; // 声音音量。1为最大
                                    $('audio')[i].pause();
                                    $('.playImgBox').removeClass('playPause').addClass('playimg'); // 重置播放图标
                                }
                            }

                            $('.audioPlayBox').on('click', function () {
                                var thisIndex = $('.audioPlayBox').index($(this));
                                if ($(this).attr('data-flag') == 'true') { // 通过判断$('.audioPlayBox')的data-flag来做操作
                                    pauseAll();
                                    $('.audioPlayBox').attr('data-flag', false);
                                    $(this).children(1).children('.playImgBox').removeClass('playPause').addClass('playimg'); // 为当前播放的加上暂停图标
                                } else {
                                    pauseAll();
                                    $(this).attr('data-flag', true);
                                    $(this).children(1).children('.playImgBox').removeClass('playimg').addClass('playPause'); // 为当前播放的加上暂停图标
                                    $('audio')[thisIndex].play();
                                }
                            })

                            //APP交互跳转
                            var $consList = $('[data-artzhe-type=link]');
                            console.log($consList);

                            //阻止默认事件函数
                            function stopDefault(e) {
                                if (e && e.preventDefault)
                                    e.preventDefault();
                                else
                                    window.event.returnValue = false; //兼容IE
                            }

                            $consList.click(function (event) {
                                stopDefault(event);
                                var index = $consList.index(this);
                                var type = $(this).attr('data-artzhe-typeDetail');
                                var id = $(this).attr('data-artzhe-id');

                                that.gotoApp(type, id);
                            });


                        });
                        that.fadeOut();
                    }
                }
            });
        },
        toggleFollow: function (msg) {
            var that = this;
            if (this.followClick) {
                return false;
            }
            this.followClick = true;

            $(event.currentTarget).find('i').removeClass('anim-zooming').addClass('anim-zooming').one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function () {
                $(this).removeClass('anim-zooming');
            }); //放大缩小动画效果

            var ocData = {
                artistId: this.update.publisherInfo.id
            };

            if (this.update.publisherInfo.isFollow == 'Y') {
                ocData.api = 'unfollow';
            } else {
                ocData.api = 'follow';
            }

            this.jsToNative(ocData);
        },
        gotoApp: function (type, id) {
            var that = this;
            var ocData = {
                api: 'link',
                type: type,
                id: id
            };

            this.jsToNative(ocData);
        },
        loadMore: function () {
            console.log(1)
            this.loading = true;
            setTimeout(() => {
                let last = this.replaylist[this.replaylist.length - 1];
                // if(i>20){this.loading =false;return false}
                for (let i = 1; i <= 10; i++) {

                    this.replaylist.push(last + i);
                }
                this.loading = false;
            }, 2500);

        },
        loadMore2: function () {},
        loadMore3: function () {},
        jsToNative: function (ocData) {
            if (this.checkUA().isAndroid) {
                ocData = JSON.stringify(ocData);
                OCModel.jsCallNative(ocData);
            }

            if (this.checkUA().isIOS) {
                try {
                    window.webkit.messageHandlers[ocData.api].postMessage(ocData);
                } catch (ex) {
                    OCModel.jsCallNative(ocData);
                }
            }
        },
        checkUA: function () {
            var isIOS, isAndroid;
            var ua = navigator.userAgent.toLowerCase();
            if (/iphone|ipad|ipod/.test(ua)) {
                isIOS = true;
                isAndroid = false;
            } else if (/android/.test(ua)) {
                isIOS = false;
                isAndroid = true;
            }
            return {
                isIOS: isIOS,
                isAndroid: isAndroid
            };
        },
        px2rem: function (con) {
            con = con.replace(/(\d)+\.?[0-9]+(px)|(\d)+(px)/gi, function (s, t) {
                s = s.replace('px', '');
                var value = parseInt(s) * 0.0266667; //   此处 1rem = 75px
                return value + "rem";
            });
            return con;
        },
        GetLocationId: function () {
            var path = window.location.pathname; //获取url中路径
            var ids = path.split('/');
            var id = ids[ids.length - 1];
            return id;
        },
        GetRequest: function () {
            var url = location.search; //获取url中"?"符后的字串
            var theRequest = {};
            if (url.indexOf("?") != -1) {
                var str = url.substr(1);
                strs = str.split("&");
                for (var i = 0; i < strs.length; i++) {
                    theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
                }
            }
            return theRequest;
        },
        formatTime: function (timespan) {
            var mdateTime = Date.parse(timespan); // 例： 2018-12-13 15:30:00 或者 2018/12/13 15:30:00
            var dateTime = new Date(timespan);
            var year = dateTime.getFullYear();
            var month = dateTime.getMonth() + 1;
            var day = dateTime.getDate();
            var hour = dateTime.getHours();
            var minute = dateTime.getMinutes();
            var second = dateTime.getSeconds();
            var now = new Date();
            var now_new = Date.parse(now);
            var milliseconds = 0;
            var timeSpanStr;
            milliseconds = now_new - mdateTime;
            if (milliseconds <= 1000 * 60 * 1) {
                timeSpanStr = '刚刚';
            } else if (1000 * 60 * 1 < milliseconds && milliseconds <= 1000 * 60 * 60) {
                timeSpanStr = Math.round((milliseconds / (1000 * 60))) + '分钟前';
            } else if (1000 * 60 * 60 * 1 < milliseconds && milliseconds <= 1000 * 60 * 60 * 24) {
                timeSpanStr = Math.round(milliseconds / (1000 * 60 * 60)) + '小时前';
            } else if (1000 * 60 * 60 * 24 < milliseconds && milliseconds <= 1000 * 60 * 60 * 24 * 15) {
                timeSpanStr = Math.round(milliseconds / (1000 * 60 * 60 * 24)) + '天前';
            } else {
                timeSpanStr = year + '-' + (month > 9 ? month : '0' + month) + '-' + (day > 9 ? day : ('0' + day)) + ' ' + (hour > 9 ? hour : '0' + hour) + ':' + (minute > 9 ? minute : '0' + minute);
            }
            return timeSpanStr;
        },
        formatTimeNoTime: function (timespan) {
            var mdateTime = Date.parse(timespan); // 例： 2018-12-13 15:30:00 或者 2018/12/13 15:30:00
            var dateTime = new Date(timespan);
            var year = dateTime.getFullYear();
            var month = dateTime.getMonth() + 1;
            var day = dateTime.getDate();
            var hour = dateTime.getHours();
            var minute = dateTime.getMinutes();
            var second = dateTime.getSeconds();
            var now = new Date();
            var now_new = Date.parse(now);
            var milliseconds = 0;
            var timeSpanStr;
            milliseconds = now_new - mdateTime;
            if (milliseconds <= 1000 * 60 * 1) {
                timeSpanStr = '刚刚';
            } else if (1000 * 60 * 1 < milliseconds && milliseconds <= 1000 * 60 * 60) {
                timeSpanStr = Math.round((milliseconds / (1000 * 60))) + '分钟前';
            } else if (1000 * 60 * 60 * 1 < milliseconds && milliseconds <= 1000 * 60 * 60 * 24) {
                timeSpanStr = Math.round(milliseconds / (1000 * 60 * 60)) + '小时前';
            } else if (1000 * 60 * 60 * 24 < milliseconds && milliseconds <= 1000 * 60 * 60 * 24 * 15) {
                timeSpanStr = Math.round(milliseconds / (1000 * 60 * 60 * 24)) + '天前';
            } else {
                timeSpanStr = year + '.' + (month > 9 ? month : '0' + month) + '.' + (day > 9 ? day : ('0' + day));
            }
            return timeSpanStr;
        },
    }
})

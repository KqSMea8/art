/**
 * API接口代理，WEB页面调用，转接入API接口
 */

(function(){
            var  _getCookie = function(key){
              var arr,reg=new RegExp("(^| )"+key+"=([^;]*)(;|$)");
              if(arr=document.cookie.match(reg)){
                return unescape(arr[2]);
              }else{
                return null;
              }
            }
            var _setCookie = function(key,value,expiredays){
             var exdate=new Date()
             exdate.setDate(exdate.getDate()+expiredays)
             document.cookie=key+ "=" +escape(value)+
             ((expiredays==null) ? "" : ";expires="+exdate.toGMTString())
           }
           var  _getUnixTimestamp = function(){
             var timestamp = Date.parse(new Date());
             return timestamp.toString().substring(0,timestamp.toString().length-3)
           }
           var _getSecret = function (timestamp,randStr){
             var key = 'artzhe_'+_getFormatDate('yyyyMMdd');
             return md5(md5(timestamp)+md5(key)+md5(key+timestamp+randStr+key));
           }
          var  _getRandString = function(len){
             var len = len || 32;
        　　var chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';
        　　var maxPos = chars.length;
        　　var pwd = '';
        　　for (i = 0; i < len; i++) {
        　　　　pwd += chars.charAt(Math.floor(Math.random() * maxPos));
        　　}
        　　return pwd;
           }
           var _getFormatDate = function(fmt){
               var date = new Date();
               var o = {
                   "M+": date.getMonth() + 1, //月份
                   "d+": date.getDate(), //日
                   "h+": date.getHours(), //小时
                   "m+": date.getMinutes(), //分
                   "s+": date.getSeconds(), //秒
                   "q+": Math.floor((date.getMonth() + 3) / 3), //季度
                   "S": date.getMilliseconds() //毫秒
               };
               if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
               for (var k in o)
               if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
               return fmt;
           }
           artzheAgent = {
              domin : window.location.protocol+'//'+window.location.host,
              _getToken : function(func){
                if(!_getCookie('apiToken')){
                  var api = this.domin+'/Api/user/getToken';
                  $.ajax({
                    type : 'POST',
                    url : api,
                    dataType : 'json',
                    async : false,
                    beforeSend : function(XMLHttpRequest){
                      var timestamp = _getUnixTimestamp();
                      var randStr = _getRandString(16);
                      var secret = _getSecret(timestamp,randStr);
                      XMLHttpRequest.setRequestHeader('X-Artzhe-Time', timestamp);
                      XMLHttpRequest.setRequestHeader('X-Artzhe-Nonce', randStr);
                      XMLHttpRequest.setRequestHeader('X-Artzhe-Sign', secret);
                    },
                    success : function(response){
                      if(response.code = '30000'){
                        _setCookie('apiToken',response.data.token)
                      }else{
                        throw new Exception(response.message);
                      }
                    }
                  })
                }
                return _getCookie('apiToken');
              },
              call : function(route,data,func){
                var sel = this;
                var token = sel._getToken();
                var api = sel.domin+'/Api/'+route+'?token='+token;
                $.post(api,data,function(response){
                  return func(response);
                },'json')
              }
            }   
})()

<extend name="Public:base"/>
<block name="content">
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    艺术家推广审核
                </div>
                <!-- /.panel-heading -->
                <div class="panel-body">
                    <link rel="stylesheet" type="text/css" href="/Public/Admin/css/extVerifySuccess.css">
                    <div>
                        <div id="wrap1" class="wrap">
                            <img class="temp-url img-responsive" src="/Public/Admin/image/template_btn_blank.png">
                            <img class="upload-img img-responsive" src="{$info['img']}">
                            <div class="info" >
                                <h3 class="name"><span>{$info['name']}</span></h3>
                                <p class="tags">{$info['category']}</p>
                                <p class="desc">"{$info['desc']}"</p>
                            </div>
                        </div>
                        <div style="height: 30px;"></div>
                        <div id="wrap2" class="wrap">
                            <img class="temp-url" src="/Public/Admin/image/template_blank.png">
                            <img class="upload-img" src="{$info['img']}">
                            <div class="info">
                                <h3 class="name"><span>{$info['name']}</span></h3>
                                <p class="tags">{$info['category']}</p>
                                <p class="desc">"{$info['desc']}"</p>
                            </div>
                        </div>
                        <div style="height: 30px;"></div>
                        <div id="wrap3" class="wrap">
                            <img class="temp-url" src="/Public/Admin/image/template_blank.png">
                            <img class="upload-img" src="{$info['img']}">
                            <div class="info">
                                <h3 class="name"><span>{$info['name']}</span></h3>
                                <p class="tags">{$info['category']}</p>
                                <p class="desc">"{$info['desc']}"</p>
                                <div class="code">
                                    <img src="{:U('Extension/getrqcode',['uid'=>$info['artist']])}">
                                    <p>长按识别二维码进入画廊</p>
                                </div>
                            </div>
                        </div>

                </div>
                    <form style="margin-top: 60px;" action="{:U('Extension/verifySuccess')}" class="form-horizontal"  method="post" onsubmit="return upload();">
                        <div class="form-group">
                            <input type="hidden" name="id" value="{$info['id']}">
                            <input type="hidden" name="one" value="" id="one">
                            <input type="hidden" name="two" value="" id="two">
                            <input type="hidden" name="three" value="" id="three">
                            <input type="hidden" name="showType" value="{$showType}" id="three">
                        </div>
                        <div class="form-group">
                            <label for="" class="col-sm-1 control-label">备注：</label>
                            <div class="col-sm-4">
                                <textarea id="reason" name="reason" class="form-control" placeholder="如审核失败，请备注审核失败的原因。" rows="5"></textarea>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-sm-offset-2 col-sm-10">
                                <button type="submit" id="fat-btn" name="button" class="btn btn-primary" >审核成功</button>&nbsp;&nbsp;
                                <a class="btn btn-primary"  onclick="verifyFailed()" >审核失败</a>
                            </div>
                        </div>
                    </form>

                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
        </div>
        <!-- /.col-lg-12 -->
    </div>
</block>
<block name="customJs">
    <script type="text/javascript">
        initLoading();
        showLoading('加载中，请稍候。。。');
        function initLoading(){
            $("body").append("<!-- loading -->" +
                "<div class='modal fade' id='loading' tabindex='-1' role='dialog' aria-labelledby='myModalLabel' data-backdrop='static'>" +
                "<div class='modal-dialog' role='document' style='width:220px'>" +
                "<div class='modal-content'>" +
                    /*  "<div class='modal-header'>" +
                     "<h4 class='modal-title' id='myModalLabel'>提示</h4>" +
                     "</div>" +*/
                "<div class='modal-body'>" +
                "<img id='loading' src='/Public/Admin/image/loading.gif' />&nbsp;" +
                "<span id='loadingText'>处理中，请稍候。。。</span>" +
                "</div>" +
                "</div>" +
                "</div>" +
                "</div>"
            );
        }
        function showLoading(text){
            $("#loadingText").html(text);
            $("#loading").modal("show");
        }
        function hideLoading(){
            $("#loading").modal("hide");
        }
    </script>
    <script type="text/javascript" src="/Public/Admin/js/html2canvas.min.js"></script>
    <script type="text/javascript">
        //initLoading();
        //showLoading('加载中，请稍候。。。');
        var one = '';
        var two = '';
        var three = '';
        $(function () {

            html2canvas(document.getElementById('wrap1')).then(function (canvas) {
                var url = canvas.toDataURL(); //以下代码为下载此图片功能
                one = transDataUrl(url);
                html2canvas(document.getElementById('wrap2')).then(function (canvas) {
                    var url = canvas.toDataURL(); //以下代码为下载此图片功能
                    two = transDataUrl(url);
                    html2canvas(document.getElementById('wrap3')).then(function (canvas) {
                        var url = canvas.toDataURL(); //以下代码为下载此图片功能
                        three = transDataUrl(url);
                        hideLoading();

                    });
                });
            });


        });

        function transDataUrl(dataurl) {
            var data = dataurl.split(',')[1];
            data = window.atob(data);
            var ia = new Uint8Array(data.length);
            for (var i = 0; i < data.length; i++) {
                ia[i] = data.charCodeAt(i);
            }
            return new Blob([ia], {type: "image/png", endings: 'transparent'});
        }


        function upload() {
            showLoading('处理中，请稍候。。。');
            var reason = $("#reason").val();
            var fd = new FormData();
            fd.append('id', "{$info['id']}");
            fd.append('one', one);
            fd.append('two', two);
            fd.append('three', three);
            fd.append('artist', "{$info['artist']}");
            fd.append('reason', reason);
            $.ajax({
                url: "{:U('Extension/upload')}",
                data: fd,
                type: 'POST',
                dataType: 'json',
                asyn: false,
                processData: false,  // 告诉jQuery不要去处理发送的数据
                contentType: false,   // 告诉jQuery不要去设置Content-Type请求头
                success: function (data) {
                   /* $('#one').val(data.one);
                    $('#two').val(data.two);
                    $('#three').val(data.three);
                    alert('上传成功');*/

                    if (data.error == 0) {
                        hideLoading();
                        $.prompt("修改成功！", {
                            title: "提示",
                            buttons: {"确定": true},
                            submit: function (e, v, m, f) {
                                if (v == true) {
                                    window.location.href="{:U('Extension/index',['showType'=>$showType])}";
                                }
                            }
                        });

                    }else{
                        hideLoading();
                        $.prompt("<span style=\" color:#F00\">"+data.message+"</span>", {
                            title: "提示",
                            buttons: {"确定": false},
                        });
                    }
                }
            });
            return false;
        }

        function verifyFailed() {
            var reason = $("#reason").val();

            var check = true;
            var message = "";
            if ($.trim(reason) == '') {
                check = false;
                message = message + "<li>备注不能为空</li>";
            }

            if (check == false) {
                $.prompt("<span style=\" color:#AD6C14\">"+message+"</span>", {
                    title: "提示",
                    buttons: {"确定": false}
                });
            } else {
              var formData = new FormData($(".form-horizontal")[0]);
                $.ajax({
                    type: 'post',
                    url: '<?php echo U('Extension/verifyFailed');?>',
                    data: formData,
                    contentType: false,
                    processData: false,
                    cache: false,
                    dataType: 'json',
                    error: function (data) {
                        $.prompt("<span style=\" color:#F00\">error</span>", {
                            title: "提示",
                            buttons: {"确定": false}
                        });
                    },
                    success: function (data) {
                        if (data.error == 0) {
                            $.prompt("提交成功！", {
                                title: "提示",
                                buttons: {"确定": true},
                                submit: function (e, v, m, f) {
                                    if (v == true) {
                                        window.location.href="{:U('Extension/index',['showType'=>$showType])}";
                                    }
                                }
                            });

                        }else{
                            $.prompt("<span style=\" color:#F00\">"+data.message+"</span>", {
                                title: "提示",
                                buttons: {"确定": false},
                            });
                        }
                    }
                });
            }
        }


    </script>
</block>

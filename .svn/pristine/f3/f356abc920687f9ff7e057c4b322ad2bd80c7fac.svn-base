<?php

namespace Common\Logic;

use Common\Base\BaseLogic;
use Common\Logic\ArtCircleLogic;
use Common\Logic\MessageLogic;
use Custom\Define\Image;
use Custom\Helper\Util;
use Think\Model;

//话题
class TopicLogic extends BaseLogic
{
    //3小时循环
    public function getHottest($limit=1){
        $hottest_cache=S('topic_hottest_list_'.$limit);
        if(is_array($hottest_cache)){
            return $hottest_cache;
        }else {
            $hottest = [];
            $time = time();
            while (count($hottest) < $limit) {
                $count = $limit - count($hottest);
                $list = $this->model
                    ->field('view_num+follow_num+discuss_num*2+share_num as count,id,title')
                    ->where(['create_time' => [['gt', $time - 10800], ['lt', $time]], 'status' => 1])
                    ->order('count desc')
                    ->limit($count)
                    ->select();
                $hottest = array_merge($hottest, $list);
                $time = $time - 10800;
            }
            S('topic_hottest_list_' . $limit, $hottest, 10800);
            return $hottest;
        }
    }

    //更新话题用户关联表
    public function ActivateUserRelationships($topic_id,$user_id){
        $thistime=time();
        $topic_user_relationships_M=M('topic_user_relationships');
        $where['topic_id']=$topic_id;
        $where['user_id']=$user_id;
        $topic_user_relationships_info=$topic_user_relationships_M->where($where)->find();
        if($topic_user_relationships_info){
            $data['update_time'] = $thistime;
            $data['is_read'] = 0;
            $topic_user_relationships_M->where($where)->save($data);
        }else{
            $data['topic_id'] = $topic_id;
            $data['user_id'] = $user_id;
            $data['update_time'] = $thistime;
            $data['creat_time'] = $thistime;
            $topic_user_relationships_M->add($data);
        }

    }
}
